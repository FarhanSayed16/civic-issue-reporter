flowchart TB
    %% Title
    subgraph Title["Civic Issue Platform – 🔒 Security + ⚙ Backend + 🤖 AI/ML"]
    end

    %% ==== Frontend ====
    subgraph FE_Group["Frontend (React + TS)"]
        FE["User Login / Register\n+ Report Issues"]
        hCaptcha["hCaptcha\n(Human Verification)"]
        Fingerprint["Device Fingerprinting\n(Unique Device ID)"]
    end

    %% ==== Backend ====
    subgraph Backend["Backend Infrastructure"]
        Nginx["Nginx\n(HTTPS, Reverse Proxy)"]
        Uvicorn["Uvicorn\n(ASGI Server)"]
        FastAPI["FastAPI\n(API Logic)"]
        WS["WebSockets\n(Real-time Updates)"]
        DB["PostgreSQL + PostGIS\n(Encrypted at Rest)"]
        Celery["Celery + Redis\n(Background Tasks)"]
    end

    %% ==== Security ====
    subgraph Security["Security Layer"]
        JWT["JWT\n(Digital ID)"]
        RBAC["RBAC\n(Role-Based Access)"]
        Validation["Input Validation\n(Pydantic Models)"]
        TLS["TLS/HTTPS\n(Encryption in Transit)"]
        DBEncrypt["DB Encryption\n(At Rest)"]
    end

    %% ==== AI/ML ====
    subgraph AI["AI/ML Layer"]
        YOLO["YOLOv8/9\n(Object Detection)"]
        NLP["NLP (DistilBERT)\nUrgency Detection"]
        Predict["Predictive Analytics\n(Future Hotspots)"]
        DupCheck["Image Similarity\n(Duplicate Check)"]
    end

    %% ==== Connections ====
    FE --> hCaptcha
    FE --> Fingerprint
    FE --> TLS

    TLS --> Nginx
    Nginx --> Uvicorn
    Uvicorn --> FastAPI

    FastAPI --> JWT
    FastAPI --> RBAC
    FastAPI --> Validation
    FastAPI --> WS
    FastAPI --> Celery
    FastAPI --> DB

    DB --> DBEncrypt

    FastAPI --> YOLO
    FastAPI --> NLP
    YOLO --> Predict
    YOLO --> DupCheck
    Predict --> DB

    %% ==== Notes ====
    NoteJWT["🔑 Secure digital ID\nUsed on every request"]
    NoteDB["🛡️ Even if DB is stolen,\ndata remains protected"]
    NoteYOLO["📷 Detect potholes, garbage,\nother civic issues"]
    NoteCelery["⚡ Background tasks keep\nAPI fast & responsive"]

    %% Connect notes with explanatory dotted lines
    JWT -.-> NoteJWT
    DBEncrypt -.-> NoteDB
    YOLO -.-> NoteYOLO
    Celery -.-> NoteCelery

    %% Styles (fixed with quotes)
    classDef note fill:#f0f0f0,stroke:#999,stroke-width:1px,color:#333;
    class NoteJWT,NoteDB,NoteYOLO,NoteCelery note
